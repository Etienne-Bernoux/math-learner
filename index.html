<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MathQuiz - Calcul Mental</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const QUESTIONS_COUNT = 10;

    // ========== STORAGE ==========
    const STORAGE_KEY = 'mathquiz_stats';

    const defaultStats = {
      totalScore: 0,
      gamesPlayed: 0,
      perfectGames: 0,
      bestStreak: 0,
      totalCorrect: 0,
      totalQuestions: 0,
      expertPerfects: 0,
      fastAnswers: 0, // r√©ponses < 2s
      achievements: [],
    };

    function loadStats() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? { ...defaultStats, ...JSON.parse(saved) } : defaultStats;
      } catch {
        return defaultStats;
      }
    }

    function saveStats(stats) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(stats));
      } catch {}
    }

    // ========== ACHIEVEMENTS ==========
    const ACHIEVEMENTS = {
      first_game:     { icon: "üéÆ", name: "Premier pas",      desc: "Terminer une partie" },
      perfect:        { icon: "üíØ", name: "Perfect",          desc: "10/10 sur une partie" },
      streak_5:       { icon: "üî•", name: "En feu",           desc: "5 bonnes r√©ponses d'affil√©e" },
      streak_10:      { icon: "‚ö°", name: "Inarr√™table",      desc: "10 bonnes r√©ponses d'affil√©e" },
      speed_demon:    { icon: "üöÄ", name: "Speed Demon",      desc: "10/10 en mode Expert" },
      veteran:        { icon: "üéñÔ∏è", name: "V√©t√©ran",          desc: "10 parties jou√©es" },
      master:         { icon: "üëë", name: "Ma√Ætre",           desc: "50 parties jou√©es" },
      perfectionist:  { icon: "‚ú®", name: "Perfectionniste",  desc: "5 parties parfaites" },
      scholar:        { icon: "üìö", name: "√ârudit",           desc: "500 bonnes r√©ponses" },
      lightning:      { icon: "‚ö°", name: "√âclair",           desc: "10 r√©ponses en moins de 2s" },
    };

    function checkAchievements(stats, gameData) {
      const newAchievements = [];
      const { results, difficulty, currentStreak } = gameData;
      const correctCount = results.filter(r => r.correct).length;
      const isPerfect = correctCount === results.length;

      // First game
      if (!stats.achievements.includes('first_game')) {
        newAchievements.push('first_game');
      }

      // Perfect game
      if (isPerfect && !stats.achievements.includes('perfect')) {
        newAchievements.push('perfect');
      }

      // Speed demon (perfect on expert)
      if (isPerfect && difficulty === 'expert' && !stats.achievements.includes('speed_demon')) {
        newAchievements.push('speed_demon');
      }

      // Streak achievements
      if (currentStreak >= 5 && !stats.achievements.includes('streak_5')) {
        newAchievements.push('streak_5');
      }
      if (currentStreak >= 10 && !stats.achievements.includes('streak_10')) {
        newAchievements.push('streak_10');
      }

      // Games played
      if (stats.gamesPlayed + 1 >= 10 && !stats.achievements.includes('veteran')) {
        newAchievements.push('veteran');
      }
      if (stats.gamesPlayed + 1 >= 50 && !stats.achievements.includes('master')) {
        newAchievements.push('master');
      }

      // Perfect games count
      if (isPerfect && stats.perfectGames + 1 >= 5 && !stats.achievements.includes('perfectionist')) {
        newAchievements.push('perfectionist');
      }

      // Total correct
      if (stats.totalCorrect + correctCount >= 500 && !stats.achievements.includes('scholar')) {
        newAchievements.push('scholar');
      }

      // Fast answers
      if (stats.fastAnswers >= 10 && !stats.achievements.includes('lightning')) {
        newAchievements.push('lightning');
      }

      return newAchievements;
    }

    const DIFFICULTY = {
      zen:    { label: "Zen",     timer: 0,  multiplier: 0.5, color: "from-sky-400 to-blue-500" },
      easy:   { label: "Facile",  timer: 12, multiplier: 1,   color: "from-green-500 to-emerald-500" },
      normal: { label: "Normal",  timer: 8,  multiplier: 1.5, color: "from-yellow-500 to-orange-500" },
      expert: { label: "Expert",  timer: 4,  multiplier: 2,   color: "from-red-500 to-pink-500" },
    };

    const MODES = {
      multiplication: { label: "Multiplication", symbol: "√ó", icon: "‚úï", color: "from-violet-500 to-purple-400" },
      division:       { label: "Division",       symbol: "√∑", icon: "√∑", color: "from-rose-400 to-pink-500" },
      addition:       { label: "Addition",       symbol: "+", icon: "+", color: "from-emerald-400 to-teal-500" },
      subtraction:    { label: "Soustraction",   symbol: "‚àí", icon: "‚àí", color: "from-amber-400 to-orange-500" },
    };

    function generateQuestions(mode, config) {
      const pool = [];

      if (mode === 'multiplication') {
        config.tables.forEach(table => {
          for (let i = 2; i <= 12; i++) {
            pool.push({ a: table, b: i, answer: table * i });
          }
        });
      } else if (mode === 'division') {
        // Division sans reste : on part de table √ó i = produit, donc produit √∑ i = table
        config.tables.forEach(table => {
          for (let i = 2; i <= 12; i++) {
            const product = table * i;
            pool.push({ a: product, b: i, answer: table });
          }
        });
      } else if (mode === 'addition') {
        for (let i = 0; i < 50; i++) {
          const a = Math.floor(Math.random() * (config.max - config.min + 1)) + config.min;
          const b = Math.floor(Math.random() * (config.max - config.min + 1)) + config.min;
          pool.push({ a, b, answer: a + b });
        }
      } else if (mode === 'subtraction') {
        for (let i = 0; i < 50; i++) {
          const a = Math.floor(Math.random() * (config.max - config.min + 1)) + config.min;
          const b = Math.floor(Math.random() * (a - config.min + 1)) + config.min;
          pool.push({ a, b, answer: a - b });
        }
      }

      const shuffled = [...pool].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, Math.min(QUESTIONS_COUNT, shuffled.length));
    }

    // Menu Screen
    function MenuScreen({ onSelect, onStats, stats }) {
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-950 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20">
            <h1 className="text-3xl font-bold text-white text-center mb-2">üßÆ MathQuiz</h1>
            <p className="text-blue-200 text-center mb-6">Choisis ton entra√Ænement</p>

            {/* Mini stats bar */}
            <div className="flex justify-center gap-6 mb-6 text-sm">
              <div className="text-center">
                <div className="text-2xl font-bold text-white">{stats.totalScore}</div>
                <div className="text-blue-300">points</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-white">{stats.gamesPlayed}</div>
                <div className="text-blue-300">parties</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-white">{stats.achievements.length}</div>
                <div className="text-blue-300">badges</div>
              </div>
            </div>

            <div className="space-y-4 mb-6">
              {Object.entries(MODES).map(([key, mode]) => (
                <button
                  key={key}
                  onClick={() => onSelect(key)}
                  className={`w-full py-5 rounded-2xl font-bold text-xl bg-gradient-to-r ${mode.color} text-white shadow-lg hover:scale-[1.02] transition-all duration-200 flex items-center justify-center gap-3`}
                >
                  <span className="text-2xl">{mode.icon}</span>
                  {mode.label}
                </button>
              ))}
            </div>

            <button
              onClick={onStats}
              className="w-full py-3 rounded-2xl font-medium text-blue-300 bg-white/10 hover:bg-white/20 transition-all flex items-center justify-center gap-2"
            >
              üèÜ Statistiques & Badges
            </button>
          </div>
        </div>
      );
    }

    // Stats Screen
    function StatsScreen({ stats, onBack, onReset }) {
      const accuracy = stats.totalQuestions > 0
        ? Math.round((stats.totalCorrect / stats.totalQuestions) * 100)
        : 0;

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-950 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20 max-h-[90vh] overflow-y-auto">
            <button onClick={onBack} className="text-blue-300 hover:text-white mb-4 transition">‚Üê Retour</button>
            <h1 className="text-2xl font-bold text-white text-center mb-6">üèÜ Statistiques</h1>

            {/* Stats grid */}
            <div className="grid grid-cols-2 gap-4 mb-8">
              <div className="bg-white/5 rounded-xl p-4 text-center">
                <div className="text-3xl font-bold text-white">{stats.totalScore}</div>
                <div className="text-blue-300 text-sm">Score total</div>
              </div>
              <div className="bg-white/5 rounded-xl p-4 text-center">
                <div className="text-3xl font-bold text-white">{stats.gamesPlayed}</div>
                <div className="text-blue-300 text-sm">Parties jou√©es</div>
              </div>
              <div className="bg-white/5 rounded-xl p-4 text-center">
                <div className="text-3xl font-bold text-white">{accuracy}%</div>
                <div className="text-blue-300 text-sm">Pr√©cision</div>
              </div>
              <div className="bg-white/5 rounded-xl p-4 text-center">
                <div className="text-3xl font-bold text-white">{stats.bestStreak}</div>
                <div className="text-blue-300 text-sm">Meilleur streak</div>
              </div>
              <div className="bg-white/5 rounded-xl p-4 text-center">
                <div className="text-3xl font-bold text-white">{stats.perfectGames}</div>
                <div className="text-blue-300 text-sm">Parties parfaites</div>
              </div>
              <div className="bg-white/5 rounded-xl p-4 text-center">
                <div className="text-3xl font-bold text-white">{stats.totalCorrect}</div>
                <div className="text-blue-300 text-sm">Bonnes r√©ponses</div>
              </div>
            </div>

            {/* Achievements */}
            <h2 className="text-lg font-bold text-white mb-4">üéñÔ∏è Badges ({stats.achievements.length}/{Object.keys(ACHIEVEMENTS).length})</h2>
            <div className="grid grid-cols-2 gap-3 mb-6">
              {Object.entries(ACHIEVEMENTS).map(([key, ach]) => {
                const unlocked = stats.achievements.includes(key);
                return (
                  <div
                    key={key}
                    className={`rounded-xl p-3 text-center transition-all ${
                      unlocked
                        ? 'bg-gradient-to-br from-amber-500/20 to-yellow-500/20 border border-amber-500/50'
                        : 'bg-white/5 opacity-50'
                    }`}
                  >
                    <div className={`text-2xl mb-1 ${unlocked ? '' : 'grayscale'}`}>{ach.icon}</div>
                    <div className={`font-medium text-sm ${unlocked ? 'text-white' : 'text-blue-300'}`}>{ach.name}</div>
                    <div className="text-xs text-blue-400">{ach.desc}</div>
                  </div>
                );
              })}
            </div>

            <button
              onClick={onReset}
              className="w-full py-2 rounded-xl text-sm text-red-400 hover:text-red-300 hover:bg-red-500/10 transition-all"
            >
              R√©initialiser les statistiques
            </button>
          </div>
        </div>
      );
    }

    // Config Screen for Tables (Multiplication & Division)
    function TablesConfig({ mode, onStart, onBack }) {
      const modeInfo = MODES[mode];
      const [selected, setSelected] = useState(new Set([2, 3, 4, 5]));
      const [difficulty, setDifficulty] = useState('normal');

      const toggle = (n) => {
        const next = new Set(selected);
        if (next.has(n)) next.delete(n);
        else next.add(n);
        setSelected(next);
      };

      const selectAll = () => setSelected(new Set([2,3,4,5,6,7,8,9,10,11,12]));
      const selectNone = () => setSelected(new Set());

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-950 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20">
            <button onClick={onBack} className="text-blue-300 hover:text-white mb-4 transition">‚Üê Retour</button>
            <h1 className="text-2xl font-bold text-white text-center mb-2">{modeInfo.icon} {modeInfo.label}</h1>
            <p className="text-blue-200 text-center mb-6">S√©lectionne les tables</p>

            <div className="flex justify-center gap-2 mb-4">
              <button onClick={selectAll} className="text-sm text-blue-300 hover:text-white transition">Tout</button>
              <span className="text-blue-500">|</span>
              <button onClick={selectNone} className="text-sm text-blue-300 hover:text-white transition">Aucun</button>
            </div>

            <div className="grid grid-cols-4 gap-3 mb-6">
              {[2,3,4,5,6,7,8,9,10,11,12].map(n => (
                <button
                  key={n}
                  onClick={() => toggle(n)}
                  className={`aspect-square rounded-xl font-bold text-lg transition-all duration-200 ${
                    selected.has(n)
                      ? "bg-blue-500 text-white shadow-lg shadow-blue-500/50 scale-105"
                      : "bg-white/10 text-blue-200 hover:bg-white/20"
                  }`}
                >
                  {n}
                </button>
              ))}
            </div>

            <DifficultySelector difficulty={difficulty} setDifficulty={setDifficulty} />

            <button
              onClick={() => selected.size > 0 && onStart({ tables: Array.from(selected) }, difficulty)}
              disabled={selected.size === 0}
              className={`w-full py-4 rounded-2xl font-bold text-lg transition-all duration-300 ${
                selected.size > 0
                  ? `bg-gradient-to-r ${modeInfo.color} text-white shadow-lg hover:scale-[1.02]`
                  : "bg-white/10 text-white/30 cursor-not-allowed"
              }`}
            >
              C'est parti ! ‚Üí
            </button>
          </div>
        </div>
      );
    }

    // Config Screen for Addition/Subtraction
    function RangeConfig({ mode, onStart, onBack }) {
      const modeInfo = MODES[mode];
      const [min, setMin] = useState(1);
      const [max, setMax] = useState(20);
      const [difficulty, setDifficulty] = useState('normal');

      const presets = [
        { label: "1-20", min: 1, max: 20 },
        { label: "1-50", min: 1, max: 50 },
        { label: "1-100", min: 1, max: 100 },
      ];

      const isValid = min >= 0 && max > min;

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-950 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20">
            <button onClick={onBack} className="text-blue-300 hover:text-white mb-4 transition">‚Üê Retour</button>
            <h1 className="text-2xl font-bold text-white text-center mb-2">{modeInfo.icon} {modeInfo.label}</h1>
            <p className="text-blue-200 text-center mb-6">Configure la plage de nombres</p>

            {/* Presets */}
            <div className="flex gap-2 mb-6">
              {presets.map(p => (
                <button
                  key={p.label}
                  onClick={() => { setMin(p.min); setMax(p.max); }}
                  className={`flex-1 py-2 rounded-xl font-medium text-sm transition-all ${
                    min === p.min && max === p.max
                      ? `bg-gradient-to-r ${modeInfo.color} text-white shadow-lg`
                      : "bg-white/10 text-blue-200 hover:bg-white/20"
                  }`}
                >
                  {p.label}
                </button>
              ))}
            </div>

            {/* Custom range */}
            <div className="flex gap-4 mb-6">
              <div className="flex-1">
                <label className="text-blue-300 text-sm mb-1 block">Min</label>
                <input
                  type="number"
                  value={min}
                  onChange={e => setMin(Math.max(0, parseInt(e.target.value) || 0))}
                  className="w-full py-3 px-4 rounded-xl bg-white/10 text-white text-center font-bold outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div className="flex-1">
                <label className="text-blue-300 text-sm mb-1 block">Max</label>
                <input
                  type="number"
                  value={max}
                  onChange={e => setMax(parseInt(e.target.value) || 0)}
                  className="w-full py-3 px-4 rounded-xl bg-white/10 text-white text-center font-bold outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>

            <DifficultySelector difficulty={difficulty} setDifficulty={setDifficulty} />

            <button
              onClick={() => isValid && onStart({ min, max }, difficulty)}
              disabled={!isValid}
              className={`w-full py-4 rounded-2xl font-bold text-lg transition-all duration-300 ${
                isValid
                  ? `bg-gradient-to-r ${modeInfo.color} text-white shadow-lg hover:scale-[1.02]`
                  : "bg-white/10 text-white/30 cursor-not-allowed"
              }`}
            >
              C'est parti ! ‚Üí
            </button>
          </div>
        </div>
      );
    }

    // Shared Difficulty Selector
    function DifficultySelector({ difficulty, setDifficulty }) {
      return (
        <div className="mb-8">
          <p className="text-blue-200 text-center text-sm mb-3">Difficult√©</p>
          <div className="flex gap-2">
            {Object.entries(DIFFICULTY).map(([key, val]) => (
              <button
                key={key}
                onClick={() => setDifficulty(key)}
                className={`flex-1 py-3 rounded-xl font-medium text-sm transition-all duration-200 ${
                  difficulty === key
                    ? `bg-gradient-to-r ${val.color} text-white shadow-lg scale-105`
                    : "bg-white/10 text-blue-200 hover:bg-white/20"
                }`}
              >
                <div>{val.label}</div>
                <div className="text-xs opacity-75">{val.timer}s ¬∑ x{val.multiplier}</div>
              </button>
            ))}
          </div>
        </div>
      );
    }

    // Quiz Screen
    function QuizScreen({ mode, questions, difficulty, onFinish, onMenu }) {
      const modeInfo = MODES[mode];
      const config = DIFFICULTY[difficulty];
      const [index, setIndex] = useState(0);
      const [answer, setAnswer] = useState("");
      const [timer, setTimer] = useState(config.timer);
      const [results, setResults] = useState([]);
      const [feedback, setFeedback] = useState(null);
      const [streak, setStreak] = useState(0);
      const [maxStreak, setMaxStreak] = useState(0);
      const inputRef = useRef(null);
      const feedbackRef = useRef(false);

      const current = questions[index];

      const nextQuestion = (newStreak, newMaxStreak) => {
        if (index + 1 >= questions.length) {
          const finalResult = { ...current, userAnswer: parseInt(answer) || null, correct: parseInt(answer) === current.answer };
          onFinish([...results, finalResult], newMaxStreak);
        } else {
          setIndex(i => i + 1);
          setAnswer("");
          setTimer(config.timer);
          setFeedback(null);
          feedbackRef.current = false;
        }
      };

      const handleTimeout = () => {
        if (feedbackRef.current) return;
        feedbackRef.current = true;
        setFeedback('wrong');
        setStreak(0);
        setResults(r => [...r, { ...current, userAnswer: null, correct: false }]);
        setTimeout(() => nextQuestion(0, maxStreak), 1200);
      };

      const handleSubmit = () => {
        if (feedbackRef.current || !answer) return;
        feedbackRef.current = true;
        const isCorrect = parseInt(answer) === current.answer;
        setFeedback(isCorrect ? 'correct' : 'wrong');

        let newStreak = streak;
        let newMaxStreak = maxStreak;
        if (isCorrect) {
          newStreak = streak + 1;
          newMaxStreak = Math.max(maxStreak, newStreak);
          setStreak(newStreak);
          setMaxStreak(newMaxStreak);
        } else {
          setStreak(0);
        }

        setResults(r => [...r, { ...current, userAnswer: parseInt(answer), correct: isCorrect }]);
        setTimeout(() => nextQuestion(newStreak, newMaxStreak), 1200);
      };

      useEffect(() => {
        if (feedbackRef.current || config.timer === 0) return;
        const interval = setInterval(() => {
          setTimer(t => {
            if (t <= 1) {
              handleTimeout();
              return config.timer;
            }
            return t - 1;
          });
        }, 1000);
        return () => clearInterval(interval);
      }, [index]);

      useEffect(() => {
        if (!feedbackRef.current && inputRef.current) {
          inputRef.current.focus();
          // Mobile: scroll input into view when keyboard opens
          setTimeout(() => {
            inputRef.current?.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      }, [index, feedback]);

      const timerPercent = (timer / config.timer) * 100;
      const timerColor = timer <= 3 ? "bg-red-500" : timer <= 5 ? "bg-yellow-500" : "bg-green-500";

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-950 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20">
            <div className="flex justify-between items-center mb-4">
              <button onClick={onMenu} className="text-blue-400 hover:text-white text-sm transition">‚úï Quitter</button>
              {streak >= 2 && (
                <span className="text-amber-400 font-bold text-sm flex items-center gap-1">
                  üî• {streak}
                </span>
              )}
              <span className="text-blue-300 font-medium">{index + 1} / {questions.length}</span>
              <div className="flex gap-1">
                {results.map((r, i) => (
                  <div key={i} className={`w-2 h-2 rounded-full ${r.correct ? 'bg-green-400' : 'bg-red-400'}`} />
                ))}
                {Array(questions.length - results.length).fill(0).map((_, i) => (
                  <div key={`empty-${i}`} className="w-2 h-2 rounded-full bg-white/20" />
                ))}
              </div>
            </div>

            {config.timer > 0 && (
              <div className="h-2 bg-white/10 rounded-full mb-8 overflow-hidden">
                <div className={`h-full ${timerColor} transition-all duration-1000 ease-linear`} style={{ width: `${timerPercent}%` }} />
              </div>
            )}

            <div className={`text-center mb-8 transition-all duration-300 ${feedback ? 'scale-95 opacity-80' : ''}`}>
              <div className="text-5xl font-bold text-white mb-2">
                {current.a} {modeInfo.symbol} {current.b}
              </div>
              <div className="text-2xl text-blue-300">= ?</div>
            </div>

            <div>
              <input
                ref={inputRef}
                type="text"
                inputMode="numeric"
                pattern="[0-9-]*"
                value={answer}
                onChange={e => setAnswer(e.target.value.replace(/[^0-9-]/g, ''))}
                onKeyDown={e => { if (e.key === 'Enter' && answer && !feedback) handleSubmit(); }}
                onFocus={e => setTimeout(() => e.target.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300)}
                disabled={!!feedback}
                className={`w-full text-center text-4xl font-bold py-4 rounded-2xl outline-none transition-all duration-300 ${
                  feedback === 'correct'
                    ? 'bg-green-500/30 text-green-300 border-2 border-green-500'
                    : feedback === 'wrong'
                    ? 'bg-red-500/30 text-red-300 border-2 border-red-500'
                    : 'bg-white/10 text-white border-2 border-transparent focus:border-blue-500'
                }`}
                placeholder="?"
                autoComplete="off"
              />

              {feedback && (
                <div className={`text-center mt-4 text-xl font-bold ${feedback === 'correct' ? 'text-green-400' : 'text-red-400'}`}>
                  {feedback === 'correct' ? '‚úì Correct !' : `‚úó C'√©tait ${current.answer}`}
                </div>
              )}

              {!feedback && (
                <button
                  onClick={handleSubmit}
                  disabled={!answer}
                  className={`w-full mt-6 py-4 rounded-2xl font-bold text-lg transition-all ${
                    answer
                      ? `bg-gradient-to-r ${modeInfo.color} text-white hover:shadow-lg`
                      : 'bg-white/10 text-white/30 cursor-not-allowed'
                  }`}
                >
                  Valider
                </button>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Result Screen
    function ResultScreen({ mode, results, difficulty, newAchievements, onRestart, onConfig, onMenu }) {
      const modeInfo = MODES[mode];
      const diffConfig = DIFFICULTY[difficulty];
      const correctCount = results.filter(r => r.correct).length;
      const score = Math.round(correctCount * diffConfig.multiplier * 10);
      const percent = Math.round((correctCount / results.length) * 100);

      const getMessage = () => {
        if (percent === 100) return { emoji: "üèÜ", text: "Parfait !" };
        if (percent >= 80) return { emoji: "üî•", text: "Excellent !" };
        if (percent >= 60) return { emoji: "üí™", text: "Pas mal !" };
        if (percent >= 40) return { emoji: "üìö", text: "Continue !" };
        return { emoji: "üéØ", text: "√Ä retravailler" };
      };

      const msg = getMessage();

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-950 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20">
            <div className="text-center mb-6">
              <div className="text-6xl mb-4">{msg.emoji}</div>
              <div className="text-5xl font-bold text-white mb-1">+{score} pts</div>
              <div className="text-lg text-blue-300 mb-1">{correctCount}/{results.length} ¬∑ {diffConfig.label} (x{diffConfig.multiplier})</div>
              <div className="text-xl text-blue-200">{msg.text}</div>
            </div>

            {/* New achievements */}
            {newAchievements.length > 0 && (
              <div className="bg-gradient-to-r from-amber-500/20 to-yellow-500/20 rounded-2xl p-4 mb-6 border border-amber-500/30">
                <div className="text-amber-300 font-bold text-center mb-3">üéâ Nouveau badge !</div>
                <div className="flex justify-center gap-4">
                  {newAchievements.map(key => {
                    const ach = ACHIEVEMENTS[key];
                    return (
                      <div key={key} className="text-center">
                        <div className="text-3xl mb-1">{ach.icon}</div>
                        <div className="text-white font-medium text-sm">{ach.name}</div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            <div className="bg-white/5 rounded-2xl p-4 mb-6 max-h-40 overflow-y-auto">
              {results.map((r, i) => (
                <div key={i} className={`flex justify-between items-center py-2 ${i > 0 ? 'border-t border-white/10' : ''}`}>
                  <span className="text-blue-200">{r.a} {modeInfo.symbol} {r.b} = {r.answer}</span>
                  <span className={r.correct ? 'text-green-400' : 'text-red-400'}>
                    {r.correct ? '‚úì' : `‚úó ${r.userAnswer ?? '‚Äî'}`}
                  </span>
                </div>
              ))}
            </div>

            <div className="space-y-3">
              <button
                onClick={onRestart}
                className={`w-full py-4 rounded-2xl font-bold text-lg bg-gradient-to-r ${modeInfo.color} text-white hover:shadow-lg transition-all`}
              >
                Rejouer ‚Üª
              </button>
              <button
                onClick={onConfig}
                className="w-full py-3 rounded-2xl font-medium text-blue-300 bg-white/10 hover:bg-white/20 transition-all"
              >
                Modifier les param√®tres
              </button>
              <button
                onClick={onMenu}
                className="w-full py-3 rounded-2xl font-medium text-blue-400 hover:text-white transition-all"
              >
                ‚Üê Menu principal
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Main App
    function App() {
      const [screen, setScreen] = useState('menu');
      const [mode, setMode] = useState(null);
      const [gameConfig, setGameConfig] = useState(null);
      const [difficulty, setDifficulty] = useState('normal');
      const [questions, setQuestions] = useState([]);
      const [results, setResults] = useState([]);
      const [stats, setStats] = useState(loadStats);
      const [newAchievements, setNewAchievements] = useState([]);
      const [currentStreak, setCurrentStreak] = useState(0);

      const selectMode = (selectedMode) => {
        setMode(selectedMode);
        setScreen('config');
      };

      const startQuiz = (config, selectedDifficulty) => {
        setGameConfig(config);
        setDifficulty(selectedDifficulty);
        setQuestions(generateQuestions(mode, config));
        setResults([]);
        setCurrentStreak(0);
        setScreen('quiz');
      };

      const finishQuiz = (quizResults, maxStreak) => {
        // Calculate stats
        const correctCount = quizResults.filter(r => r.correct).length;
        const diffConfig = DIFFICULTY[difficulty];
        const score = Math.round(correctCount * diffConfig.multiplier * 10);
        const isPerfect = correctCount === quizResults.length;

        // Check achievements
        const gameData = {
          results: quizResults,
          difficulty,
          currentStreak: maxStreak,
        };
        const unlocked = checkAchievements(stats, gameData);
        setNewAchievements(unlocked);

        // Update stats
        const newStats = {
          ...stats,
          totalScore: stats.totalScore + score,
          gamesPlayed: stats.gamesPlayed + 1,
          perfectGames: stats.perfectGames + (isPerfect ? 1 : 0),
          bestStreak: Math.max(stats.bestStreak, maxStreak),
          totalCorrect: stats.totalCorrect + correctCount,
          totalQuestions: stats.totalQuestions + quizResults.length,
          achievements: [...stats.achievements, ...unlocked],
        };

        setStats(newStats);
        saveStats(newStats);
        setResults(quizResults);
        setScreen('result');
      };

      const restart = () => {
        setQuestions(generateQuestions(mode, gameConfig));
        setResults([]);
        setCurrentStreak(0);
        setNewAchievements([]);
        setScreen('quiz');
      };

      const goConfig = () => setScreen('config');
      const goMenu = () => { setScreen('menu'); setMode(null); setNewAchievements([]); };
      const goStats = () => setScreen('stats');

      const resetStats = () => {
        if (confirm('R√©initialiser toutes les statistiques ?')) {
          setStats(defaultStats);
          saveStats(defaultStats);
        }
      };

      if (screen === 'menu') return <MenuScreen onSelect={selectMode} onStats={goStats} stats={stats} />;

      if (screen === 'stats') return <StatsScreen stats={stats} onBack={goMenu} onReset={resetStats} />;

      if (screen === 'config') {
        if (mode === 'multiplication' || mode === 'division') {
          return <TablesConfig mode={mode} onStart={startQuiz} onBack={goMenu} />;
        }
        return <RangeConfig mode={mode} onStart={startQuiz} onBack={goMenu} />;
      }

      if (screen === 'quiz') {
        return <QuizScreen mode={mode} questions={questions} difficulty={difficulty} onFinish={finishQuiz} onMenu={goMenu} />;
      }

      return <ResultScreen mode={mode} results={results} difficulty={difficulty} newAchievements={newAchievements} onRestart={restart} onConfig={goConfig} onMenu={goMenu} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
