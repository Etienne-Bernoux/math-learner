<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MathQuiz - Calcul Mental</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const QUESTIONS_COUNT = 10;

    const DIFFICULTY = {
      easy:   { label: "Facile",  timer: 12, multiplier: 1,   color: "from-green-500 to-emerald-500" },
      normal: { label: "Normal",  timer: 8,  multiplier: 1.5, color: "from-yellow-500 to-orange-500" },
      expert: { label: "Expert",  timer: 4,  multiplier: 2,   color: "from-red-500 to-pink-500" },
    };

    const MODES = {
      multiplication: { label: "Multiplication", symbol: "√ó", icon: "‚úï", color: "from-purple-500 to-pink-500" },
      addition:       { label: "Addition",       symbol: "+", icon: "+", color: "from-blue-500 to-cyan-500" },
      subtraction:    { label: "Soustraction",   symbol: "‚àí", icon: "‚àí", color: "from-orange-500 to-red-500" },
    };

    function generateQuestions(mode, config) {
      const pool = [];

      if (mode === 'multiplication') {
        config.tables.forEach(table => {
          for (let i = 2; i <= 12; i++) {
            pool.push({ a: table, b: i, answer: table * i });
          }
        });
      } else if (mode === 'addition') {
        for (let i = 0; i < 50; i++) {
          const a = Math.floor(Math.random() * (config.max - config.min + 1)) + config.min;
          const b = Math.floor(Math.random() * (config.max - config.min + 1)) + config.min;
          pool.push({ a, b, answer: a + b });
        }
      } else if (mode === 'subtraction') {
        for (let i = 0; i < 50; i++) {
          const a = Math.floor(Math.random() * (config.max - config.min + 1)) + config.min;
          const b = Math.floor(Math.random() * (a - config.min + 1)) + config.min;
          pool.push({ a, b, answer: a - b });
        }
      }

      const shuffled = [...pool].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, Math.min(QUESTIONS_COUNT, shuffled.length));
    }

    // Menu Screen
    function MenuScreen({ onSelect }) {
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20">
            <h1 className="text-3xl font-bold text-white text-center mb-2">üßÆ MathQuiz</h1>
            <p className="text-purple-200 text-center mb-8">Choisis ton entra√Ænement</p>

            <div className="space-y-4">
              {Object.entries(MODES).map(([key, mode]) => (
                <button
                  key={key}
                  onClick={() => onSelect(key)}
                  className={`w-full py-5 rounded-2xl font-bold text-xl bg-gradient-to-r ${mode.color} text-white shadow-lg hover:scale-[1.02] transition-all duration-200 flex items-center justify-center gap-3`}
                >
                  <span className="text-2xl">{mode.icon}</span>
                  {mode.label}
                </button>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // Config Screen for Multiplication
    function MultiplicationConfig({ onStart, onBack }) {
      const [selected, setSelected] = useState(new Set([2, 3, 4, 5]));
      const [difficulty, setDifficulty] = useState('normal');

      const toggle = (n) => {
        const next = new Set(selected);
        if (next.has(n)) next.delete(n);
        else next.add(n);
        setSelected(next);
      };

      const selectAll = () => setSelected(new Set([2,3,4,5,6,7,8,9,10,11,12]));
      const selectNone = () => setSelected(new Set());

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20">
            <button onClick={onBack} className="text-purple-300 hover:text-white mb-4 transition">‚Üê Retour</button>
            <h1 className="text-2xl font-bold text-white text-center mb-2">√ó Multiplication</h1>
            <p className="text-purple-200 text-center mb-6">S√©lectionne les tables</p>

            <div className="flex justify-center gap-2 mb-4">
              <button onClick={selectAll} className="text-sm text-purple-300 hover:text-white transition">Tout</button>
              <span className="text-purple-500">|</span>
              <button onClick={selectNone} className="text-sm text-purple-300 hover:text-white transition">Aucun</button>
            </div>

            <div className="grid grid-cols-4 gap-3 mb-6">
              {[2,3,4,5,6,7,8,9,10,11,12].map(n => (
                <button
                  key={n}
                  onClick={() => toggle(n)}
                  className={`aspect-square rounded-xl font-bold text-lg transition-all duration-200 ${
                    selected.has(n)
                      ? "bg-purple-500 text-white shadow-lg shadow-purple-500/50 scale-105"
                      : "bg-white/10 text-purple-200 hover:bg-white/20"
                  }`}
                >
                  {n}
                </button>
              ))}
            </div>

            <DifficultySelector difficulty={difficulty} setDifficulty={setDifficulty} />

            <button
              onClick={() => selected.size > 0 && onStart({ tables: Array.from(selected) }, difficulty)}
              disabled={selected.size === 0}
              className={`w-full py-4 rounded-2xl font-bold text-lg transition-all duration-300 ${
                selected.size > 0
                  ? "bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg hover:shadow-purple-500/50 hover:scale-[1.02]"
                  : "bg-white/10 text-white/30 cursor-not-allowed"
              }`}
            >
              C'est parti ! ‚Üí
            </button>
          </div>
        </div>
      );
    }

    // Config Screen for Addition/Subtraction
    function RangeConfig({ mode, onStart, onBack }) {
      const modeInfo = MODES[mode];
      const [min, setMin] = useState(1);
      const [max, setMax] = useState(20);
      const [difficulty, setDifficulty] = useState('normal');

      const presets = [
        { label: "1-20", min: 1, max: 20 },
        { label: "1-50", min: 1, max: 50 },
        { label: "1-100", min: 1, max: 100 },
      ];

      const isValid = min >= 0 && max > min;

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20">
            <button onClick={onBack} className="text-purple-300 hover:text-white mb-4 transition">‚Üê Retour</button>
            <h1 className="text-2xl font-bold text-white text-center mb-2">{modeInfo.icon} {modeInfo.label}</h1>
            <p className="text-purple-200 text-center mb-6">Configure la plage de nombres</p>

            {/* Presets */}
            <div className="flex gap-2 mb-6">
              {presets.map(p => (
                <button
                  key={p.label}
                  onClick={() => { setMin(p.min); setMax(p.max); }}
                  className={`flex-1 py-2 rounded-xl font-medium text-sm transition-all ${
                    min === p.min && max === p.max
                      ? `bg-gradient-to-r ${modeInfo.color} text-white shadow-lg`
                      : "bg-white/10 text-purple-200 hover:bg-white/20"
                  }`}
                >
                  {p.label}
                </button>
              ))}
            </div>

            {/* Custom range */}
            <div className="flex gap-4 mb-6">
              <div className="flex-1">
                <label className="text-purple-300 text-sm mb-1 block">Min</label>
                <input
                  type="number"
                  value={min}
                  onChange={e => setMin(Math.max(0, parseInt(e.target.value) || 0))}
                  className="w-full py-3 px-4 rounded-xl bg-white/10 text-white text-center font-bold outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>
              <div className="flex-1">
                <label className="text-purple-300 text-sm mb-1 block">Max</label>
                <input
                  type="number"
                  value={max}
                  onChange={e => setMax(parseInt(e.target.value) || 0)}
                  className="w-full py-3 px-4 rounded-xl bg-white/10 text-white text-center font-bold outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>
            </div>

            <DifficultySelector difficulty={difficulty} setDifficulty={setDifficulty} />

            <button
              onClick={() => isValid && onStart({ min, max }, difficulty)}
              disabled={!isValid}
              className={`w-full py-4 rounded-2xl font-bold text-lg transition-all duration-300 ${
                isValid
                  ? `bg-gradient-to-r ${modeInfo.color} text-white shadow-lg hover:scale-[1.02]`
                  : "bg-white/10 text-white/30 cursor-not-allowed"
              }`}
            >
              C'est parti ! ‚Üí
            </button>
          </div>
        </div>
      );
    }

    // Shared Difficulty Selector
    function DifficultySelector({ difficulty, setDifficulty }) {
      return (
        <div className="mb-8">
          <p className="text-purple-200 text-center text-sm mb-3">Difficult√©</p>
          <div className="flex gap-2">
            {Object.entries(DIFFICULTY).map(([key, val]) => (
              <button
                key={key}
                onClick={() => setDifficulty(key)}
                className={`flex-1 py-3 rounded-xl font-medium text-sm transition-all duration-200 ${
                  difficulty === key
                    ? `bg-gradient-to-r ${val.color} text-white shadow-lg scale-105`
                    : "bg-white/10 text-purple-200 hover:bg-white/20"
                }`}
              >
                <div>{val.label}</div>
                <div className="text-xs opacity-75">{val.timer}s ¬∑ x{val.multiplier}</div>
              </button>
            ))}
          </div>
        </div>
      );
    }

    // Quiz Screen
    function QuizScreen({ mode, questions, difficulty, onFinish }) {
      const modeInfo = MODES[mode];
      const config = DIFFICULTY[difficulty];
      const [index, setIndex] = useState(0);
      const [answer, setAnswer] = useState("");
      const [timer, setTimer] = useState(config.timer);
      const [results, setResults] = useState([]);
      const [feedback, setFeedback] = useState(null);
      const inputRef = useRef(null);
      const feedbackRef = useRef(false);

      const current = questions[index];

      const nextQuestion = () => {
        if (index + 1 >= questions.length) {
          const finalResult = { ...current, userAnswer: parseInt(answer) || null, correct: parseInt(answer) === current.answer };
          onFinish([...results, finalResult]);
        } else {
          setIndex(i => i + 1);
          setAnswer("");
          setTimer(config.timer);
          setFeedback(null);
          feedbackRef.current = false;
        }
      };

      const handleTimeout = () => {
        if (feedbackRef.current) return;
        feedbackRef.current = true;
        setFeedback('wrong');
        setResults(r => [...r, { ...current, userAnswer: null, correct: false }]);
        setTimeout(nextQuestion, 1200);
      };

      const handleSubmit = () => {
        if (feedbackRef.current || !answer) return;
        feedbackRef.current = true;
        const isCorrect = parseInt(answer) === current.answer;
        setFeedback(isCorrect ? 'correct' : 'wrong');
        setResults(r => [...r, { ...current, userAnswer: parseInt(answer), correct: isCorrect }]);
        setTimeout(nextQuestion, 1200);
      };

      useEffect(() => {
        if (feedbackRef.current) return;
        const interval = setInterval(() => {
          setTimer(t => {
            if (t <= 1) {
              handleTimeout();
              return config.timer;
            }
            return t - 1;
          });
        }, 1000);
        return () => clearInterval(interval);
      }, [index]);

      useEffect(() => {
        if (!feedbackRef.current && inputRef.current) {
          inputRef.current.focus();
          // Mobile: scroll input into view when keyboard opens
          setTimeout(() => {
            inputRef.current?.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      }, [index, feedback]);

      const timerPercent = (timer / config.timer) * 100;
      const timerColor = timer <= 3 ? "bg-red-500" : timer <= 5 ? "bg-yellow-500" : "bg-green-500";

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20">
            <div className="flex justify-between items-center mb-6">
              <span className="text-purple-300 font-medium">{index + 1} / {questions.length}</span>
              <div className="flex gap-1">
                {results.map((r, i) => (
                  <div key={i} className={`w-2 h-2 rounded-full ${r.correct ? 'bg-green-400' : 'bg-red-400'}`} />
                ))}
                {Array(questions.length - results.length).fill(0).map((_, i) => (
                  <div key={`empty-${i}`} className="w-2 h-2 rounded-full bg-white/20" />
                ))}
              </div>
            </div>

            <div className="h-2 bg-white/10 rounded-full mb-8 overflow-hidden">
              <div className={`h-full ${timerColor} transition-all duration-1000 ease-linear`} style={{ width: `${timerPercent}%` }} />
            </div>

            <div className={`text-center mb-8 transition-all duration-300 ${feedback ? 'scale-95 opacity-80' : ''}`}>
              <div className="text-5xl font-bold text-white mb-2">
                {current.a} {modeInfo.symbol} {current.b}
              </div>
              <div className="text-2xl text-purple-300">= ?</div>
            </div>

            <div>
              <input
                ref={inputRef}
                type="text"
                inputMode="numeric"
                pattern="[0-9-]*"
                value={answer}
                onChange={e => setAnswer(e.target.value.replace(/[^0-9-]/g, ''))}
                onKeyDown={e => { if (e.key === 'Enter' && answer && !feedback) handleSubmit(); }}
                onFocus={e => setTimeout(() => e.target.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300)}
                disabled={!!feedback}
                className={`w-full text-center text-4xl font-bold py-4 rounded-2xl outline-none transition-all duration-300 ${
                  feedback === 'correct'
                    ? 'bg-green-500/30 text-green-300 border-2 border-green-500'
                    : feedback === 'wrong'
                    ? 'bg-red-500/30 text-red-300 border-2 border-red-500'
                    : 'bg-white/10 text-white border-2 border-transparent focus:border-purple-500'
                }`}
                placeholder="?"
                autoComplete="off"
              />

              {feedback && (
                <div className={`text-center mt-4 text-xl font-bold ${feedback === 'correct' ? 'text-green-400' : 'text-red-400'}`}>
                  {feedback === 'correct' ? '‚úì Correct !' : `‚úó C'√©tait ${current.answer}`}
                </div>
              )}

              {!feedback && (
                <button
                  onClick={handleSubmit}
                  disabled={!answer}
                  className={`w-full mt-6 py-4 rounded-2xl font-bold text-lg transition-all ${
                    answer
                      ? `bg-gradient-to-r ${modeInfo.color} text-white hover:shadow-lg`
                      : 'bg-white/10 text-white/30 cursor-not-allowed'
                  }`}
                >
                  Valider
                </button>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Result Screen
    function ResultScreen({ mode, results, difficulty, onRestart, onConfig, onMenu }) {
      const modeInfo = MODES[mode];
      const diffConfig = DIFFICULTY[difficulty];
      const correctCount = results.filter(r => r.correct).length;
      const score = Math.round(correctCount * diffConfig.multiplier * 10);
      const percent = Math.round((correctCount / results.length) * 100);

      const getMessage = () => {
        if (percent === 100) return { emoji: "üèÜ", text: "Parfait !" };
        if (percent >= 80) return { emoji: "üî•", text: "Excellent !" };
        if (percent >= 60) return { emoji: "üí™", text: "Pas mal !" };
        if (percent >= 40) return { emoji: "üìö", text: "Continue !" };
        return { emoji: "üéØ", text: "√Ä retravailler" };
      };

      const msg = getMessage();

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md shadow-2xl border border-white/20">
            <div className="text-center mb-8">
              <div className="text-6xl mb-4">{msg.emoji}</div>
              <div className="text-5xl font-bold text-white mb-1">{score} pts</div>
              <div className="text-lg text-purple-300 mb-1">{correctCount}/{results.length} ¬∑ {diffConfig.label} (x{diffConfig.multiplier})</div>
              <div className="text-xl text-purple-200">{msg.text}</div>
            </div>

            <div className="bg-white/5 rounded-2xl p-4 mb-8 max-h-48 overflow-y-auto">
              {results.map((r, i) => (
                <div key={i} className={`flex justify-between items-center py-2 ${i > 0 ? 'border-t border-white/10' : ''}`}>
                  <span className="text-purple-200">{r.a} {modeInfo.symbol} {r.b} = {r.answer}</span>
                  <span className={r.correct ? 'text-green-400' : 'text-red-400'}>
                    {r.correct ? '‚úì' : `‚úó ${r.userAnswer ?? '‚Äî'}`}
                  </span>
                </div>
              ))}
            </div>

            <div className="space-y-3">
              <button
                onClick={onRestart}
                className={`w-full py-4 rounded-2xl font-bold text-lg bg-gradient-to-r ${modeInfo.color} text-white hover:shadow-lg transition-all`}
              >
                Rejouer ‚Üª
              </button>
              <button
                onClick={onConfig}
                className="w-full py-3 rounded-2xl font-medium text-purple-300 bg-white/10 hover:bg-white/20 transition-all"
              >
                Modifier les param√®tres
              </button>
              <button
                onClick={onMenu}
                className="w-full py-3 rounded-2xl font-medium text-purple-400 hover:text-white transition-all"
              >
                ‚Üê Menu principal
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Main App
    function App() {
      const [screen, setScreen] = useState('menu');
      const [mode, setMode] = useState(null);
      const [gameConfig, setGameConfig] = useState(null);
      const [difficulty, setDifficulty] = useState('normal');
      const [questions, setQuestions] = useState([]);
      const [results, setResults] = useState([]);

      const selectMode = (selectedMode) => {
        setMode(selectedMode);
        setScreen('config');
      };

      const startQuiz = (config, selectedDifficulty) => {
        setGameConfig(config);
        setDifficulty(selectedDifficulty);
        setQuestions(generateQuestions(mode, config));
        setResults([]);
        setScreen('quiz');
      };

      const finishQuiz = (quizResults) => {
        setResults(quizResults);
        setScreen('result');
      };

      const restart = () => {
        setQuestions(generateQuestions(mode, gameConfig));
        setResults([]);
        setScreen('quiz');
      };

      const goConfig = () => setScreen('config');
      const goMenu = () => { setScreen('menu'); setMode(null); };

      if (screen === 'menu') return <MenuScreen onSelect={selectMode} />;

      if (screen === 'config') {
        if (mode === 'multiplication') {
          return <MultiplicationConfig onStart={startQuiz} onBack={goMenu} />;
        }
        return <RangeConfig mode={mode} onStart={startQuiz} onBack={goMenu} />;
      }

      if (screen === 'quiz') {
        return <QuizScreen mode={mode} questions={questions} difficulty={difficulty} onFinish={finishQuiz} />;
      }

      return <ResultScreen mode={mode} results={results} difficulty={difficulty} onRestart={restart} onConfig={goConfig} onMenu={goMenu} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
